<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Atkin Guitars Leave Calendar</title>
    <link rel="icon" href="data:,">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
        updateDoc,
        deleteDoc,
        doc
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      window.dbApi = { db, collection, getDocs, addDoc, updateDoc, deleteDoc, doc };
    </script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">

      const {useState} = React;

      const isWorkingDay = (date) => {
        const day = date.getDay();
        return day !== 0 && day !== 6;
      };

      const countWorkingDaysInRange = (start, end) => {
        const s = new Date(start), e = new Date(end);
        let d = new Date(s), count = 0;
        while (d <= e) {
          if (isWorkingDay(d)) count++;
          d.setDate(d.getDate() + 1);
        }
        return count;
      };

      const daysWithinYear = (start, end, year) => {
        const s = new Date(start), e = new Date(end);
        let d = new Date(s);
        const days = [];
        while (d <= e) {
          if (d.getFullYear() === year && isWorkingDay(d)) {
            days.push(new Date(d));
          }
          d.setDate(d.getDate() + 1);
        }
        return days;
      };

      const isExcludedDate = (leave, date) => {
        const list = leave.excludedDates || leave.exclusions || [];
        if (!Array.isArray(list) || list.length === 0) return false;
        const ds = date.toISOString().slice(0,10);
        return list.some(x => {
          const v = (typeof x === 'string') ? x : (x?.date || x);
          return String(v).slice(0,10) === ds;
        });
      };

      const hoursUsedInYearForLeave = (leave, year) => {
        const start = new Date(leave.startDate);
        const end = new Date(leave.endDate || leave.startDate);
        const totalWorking = countWorkingDaysInRange(start, end);
        if (totalWorking <= 0) return 0;
        const totalHours = Number(leave.hours || 0);
        const hrsPerDay = totalHours / totalWorking;
        const inYearDays = daysWithinYear(start, end, year)
          .filter(d => !isExcludedDate(leave, d));
        return inYearDays.length * hrsPerDay;
      };

      const usedHoursInYearFor = (empId, year, leaveRequests) => {
        return leaveRequests
          .filter(l => l.employeeId === empId && l.type !== 'In Lieu' && l.status !== 'cancelled')
          .reduce((sum, l) => sum + hoursUsedInYearForLeave(l, year), 0);
      };

      function App() {
        const [employees] = useState([{id: 1, name: "Andy", totalLeave: 160}]);
        const [leaveRequests] = useState([]);
        const [quickLeaveForm] = useState({employeeId: "1", duration: "D:1", type: "Annual Leave"});

        const saveQuickLeave = async () => {
          const employee = employees.find(emp => emp.id === parseInt(quickLeaveForm.employeeId));
          if (!employee) return;
          const [unit, valueStr] = String(quickLeaveForm.duration).split(":");
          const n = Math.max(1, parseInt(valueStr || "1"));
          const isHours = unit === "H";
          const totalHours = isHours ? n : n*8;

          if (quickLeaveForm.type !== "In Lieu") {
            const currentYear = new Date().getFullYear();
            const usedThisYear = usedHoursInYearFor(employee.id, currentYear, leaveRequests);
            const remaining = (employee.totalLeave || 0) - usedThisYear;
            const willExceedBy = totalHours - Math.max(0, remaining);
            if (totalHours > remaining) {
              const msg = `Warning: this will exceed ${employee.name}'s allocation.\n\n` +
                          `Allocated: ${employee.totalLeave || 0}h\n` +
                          `Used this year: ${usedThisYear}h\n` +
                          `Request: ${totalHours}h\n` +
                          `Exceeds by: ${willExceedBy}h\n\n` +
                          `Do you want to continue?`;
              if (!window.confirm(msg)) {
                alert("Leave not added");
                return;
              }
            }
          }
          alert("Leave saved (demo)");
        };

        return (
          <div className="p-8">
            <h1 className="text-xl font-bold mb-4">Leave Calendar</h1>
            <button onClick={saveQuickLeave} className="px-4 py-2 bg-blue-600 text-white rounded">Save Leave</button>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
