<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atkin Guitars Leave Calendar</title>
  <link rel="icon" href="data:,">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .connection-indicator { position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 8px 16px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 8px; transition: opacity 0.3s; }
    .connection-indicator.hide { opacity: 0; transform: translateX(100%); }
    .connected { background-color: #10B981; color: white; }
    .disconnected { background-color: #EF4444; color: white; }
    .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s; z-index: 1000; }
    .sidebar.open { transform: translateX(0); }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .sidebar-overlay.show { opacity: 1; visibility: visible; }
    .notification { position: fixed; top: 80px; right: 20px; z-index: 1000; padding: 12px 16px; border-radius: 8px; color: white; transform: translateX(100%); transition: transform 0.3s; }
    .notification.show { transform: translateX(0); }
    .notification.success { background-color: #10B981; }
    .notification.error { background-color: #EF4444; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Firebase v12 ESM init -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, enableIndexedDbPersistence,
      collection, doc, getDocs, getDoc, setDoc, deleteDoc,
      writeBatch, query, orderBy, Timestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8zcVQBrK_Q_WQZKa856u2ka901eakX0A",
      authDomain: "atkin-guitars-94dd8.firebaseapp.com",
      projectId: "atkin-guitars-94dd8",
      storageBucket: "atkin-guitars-94dd8.appspot.com",
      messagingSenderId: "501290829079",
      appId: "1:501290829079:web:e6d21711bccb47654ae352"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(() => {});

    const ready = new Promise((resolve) => {
      let resolved = false;
      onAuthStateChanged(auth, (user) => {
        if (user && !resolved) { resolved = true; resolve(user); }
      });
      signInAnonymously(auth).catch(() => resolved || resolve(null));
    });

    window.__fb = {
      app, auth, db, ready,
      api: { collection, doc, getDocs, getDoc, setDoc, deleteDoc, writeBatch, query, orderBy, Timestamp, onSnapshot }
    };
  </script>

  <!-- App code -->
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const Icon = ({ name, className }) => {
      const paths = {
        calendar: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
        menu: "M4 6h16M4 12h16M4 18h16",
        x: "M6 18L18 6M6 6l12 12",
        wifi: "M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0",
        wifiOff: "M18.364 5.636l-12.728 12.728m0 0L1.394 14.122m4.242 4.242a5.5 5.5 0 007.778 0m7.778-7.778a10.97 10.97 0 00-3.536-2.464"
      };
      return (
        <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={paths[name]} />
        </svg>
      );
    };

    // ---------- Firestore-backed Database API ----------
    class DatabaseAPI {
      constructor(addNotificationCb) {
        this.addNotification = addNotificationCb || (() => {});
        this.fb = window.__fb || {};
        this.db = this.fb.db;
        this.api = this.fb.api || {};
        this.unsubs = { employees: null, leaves: null, shutdowns: null };
      }

      _tsToDate(v) {
        if (!v) return null;
        if (v && typeof v.toDate === "function") return v.toDate();
        if (typeof v === "string") return new Date(v);
        return v instanceof Date ? v : null;
      }

      subscribeEmployees(setter) {
        if (!this.db) return () => {};
        const { collection, query, orderBy, onSnapshot } = this.api;
        const q = query(collection(this.db, "employees"), orderBy("name"));
        this.unsubs.employees?.();
        this.unsubs.employees = onSnapshot(q, (snap) => {
          const arr = snap.docs.map(d => d.data()).filter(Boolean);
          setter(arr);
        });
        return this.unsubs.employees;
      }

      subscribeLeaveRequests(setter) {
        if (!this.db) return () => {};
        const { collection, onSnapshot } = this.api;
        const ref = collection(this.db, "leave_requests");
        this.unsubs.leaves?.();
        this.unsubs.leaves = onSnapshot(ref, (snap) => {
          const rows = snap.docs.map(d => {
            const v = d.data();
            return v ? {
              id: v.id ?? d.id,
              ...v,
              startDate: this._tsToDate(v.startDate),
              endDate: this._tsToDate(v.endDate)
            } : null;
          }).filter(Boolean);
          setter(rows);
        });
        return this.unsubs.leaves;
      }

      subscribeWorkshopShutdowns(setter) {
        if (!this.db) return () => {};
        const { collection, onSnapshot } = this.api;
        const ref = collection(this.db, "workshop_shutdowns");
        this.unsubs.shutdowns?.();
        this.unsubs.shutdowns = onSnapshot(ref, (snap) => {
          const rows = snap.docs.map(d => {
            const v = d.data();
            return v ? { id: v.id ?? d.id, ...v, startDate: this._tsToDate(v.startDate), endDate: this._tsToDate(v.endDate) } : null;
          }).filter(Boolean);
          setter(rows);
        });
        return this.unsubs.shutdowns;
      }

      async fetchEmployees() {
        if (!this.db) {
          const stored = localStorage.getItem('atkin_employees');
          return stored ? JSON.parse(stored).filter(Boolean) : [
            { id: 1, name: 'Sarah Johnson', department: 'Workshop', totalLeave: 200, usedLeave: 64, avatar: 'SJ', color: '#3B82F6' },
            { id: 2, name: 'Michael Chen', department: 'Finishing', totalLeave: 160, usedLeave: 32, avatar: 'MC', color: '#10B981' },
            { id: 3, name: 'Emma Davis', department: 'Administration', totalLeave: 180, usedLeave: 96, avatar: 'ED', color: '#F59E0B' }
          ];
        }
        const { collection, getDocs, query, orderBy } = this.api;
        const snap = await getDocs(query(collection(this.db, "employees"), orderBy("name")));
        return snap.docs.map(d => d.data()).filter(Boolean);
      }

      async fetchLeaveRequests() {
        if (!this.db) {
          const stored = localStorage.getItem('atkin_leave_requests');
          if (stored) return JSON.parse(stored).map(r => r && ({...r, startDate:new Date(r.startDate), endDate:new Date(r.endDate)})).filter(Boolean);
          return [{ id: 1, employeeId: 1, startDate: new Date(2025,7,25), endDate: new Date(2025,7,25), type: 'Annual Leave', status: 'approved', hours: 8 }];
        }
        const { collection, getDocs } = this.api;
        const snap = await getDocs(collection(this.db, "leave_requests"));
        return snap.docs.map(d => {
          const v = d.data();
          return v ? { id: v.id ?? d.id, ...v, startDate: this._tsToDate(v.startDate), endDate: this._tsToDate(v.endDate) } : null;
        }).filter(Boolean);
      }

      async fetchWorkshopShutdowns() {
        if (!this.db) {
          const stored = localStorage.getItem('atkin_workshop_shutdowns');
          if (stored) return JSON.parse(stored).map(s => s && ({...s, startDate:new Date(s.startDate), endDate:new Date(s.endDate)})).filter(Boolean);
          return [];
        }
        const { collection, getDocs } = this.api;
        const snap = await getDocs(collection(this.db, "workshop_shutdowns"));
        return snap.docs.map(d => {
          const v = d.data();
          return v ? { id: v.id ?? d.id, ...v, startDate: this._tsToDate(v.startDate), endDate: this._tsToDate(v.endDate) } : null;
        }).filter(Boolean);
      }

      async upsertEmployee(emp) {
        if (!this.db) {
          const arr = await this.fetchEmployees();
          const i = arr.findIndex(e => e.id === emp.id);
          if (i >= 0) arr[i] = emp; else arr.push(emp);
          localStorage.setItem('atkin_employees', JSON.stringify(arr));
          return;
        }
        const { doc, setDoc } = this.api;
        await setDoc(doc(this.db, "employees", String(emp.id)), emp, { merge: true });
      }

      async deleteEmployee(id) {
        if (!this.db) {
          const arr = (await this.fetchEmployees()).filter(e => e && e.id !== id);
          localStorage.setItem('atkin_employees', JSON.stringify(arr));
          return;
        }
        const { doc, deleteDoc } = this.api;
        await deleteDoc(doc(this.db, "employees", String(id)));
      }

      async createLeave(leave) {
        if (!this.db) {
          const arr = await this.fetchLeaveRequests();
          arr.push({ ...leave, id: `local-${Date.now()}` });
          localStorage.setItem('atkin_leave_requests', JSON.stringify(arr.map(r => r && ({...r, startDate:r.startDate.toISOString(), endDate:r.endDate.toISOString()})).filter(Boolean)));
          return;
        }
        const { collection, doc, setDoc } = this.api;
        const ref = doc(collection(this.db, "leave_requests"));
        await setDoc(ref, { ...leave, id: ref.id });
      }

      async updateLeave(leaveId, partial) {
        if (!this.db) {
          const arr = await this.fetchLeaveRequests();
          const i = arr.findIndex(r => r && r.id === leaveId);
          if (i >= 0) {
            const merged = { ...arr[i], ...partial };
            arr[i] = merged;
            localStorage.setItem('atkin_leave_requests', JSON.stringify(arr.map(r => r && ({...r, startDate:new Date(r.startDate).toISOString(), endDate:new Date(r.endDate).toISOString()})).filter(Boolean)));
          }
          return;
        }
        const { doc, setDoc } = this.api;
        await setDoc(doc(this.db, "leave_requests", String(leaveId)), partial, { merge: true });
      }

      async deleteLeaveRequest(id) {
        if (!id) return;
        if (!this.db) {
          const arr = (await this.fetchLeaveRequests()).filter(r => r && r.id !== id);
          localStorage.setItem('atkin_leave_requests', JSON.stringify(arr.map(r => r && ({...r, startDate:r.startDate.toISOString(), endDate:r.endDate.toISOString()})).filter(Boolean)));
          return;
        }
        const { doc, deleteDoc } = this.api;
        await deleteDoc(doc(this.db, "leave_requests", String(id)));
      }

      async createShutdown(s) {
        if (!this.db) {
          const arr = await this.fetchWorkshopShutdowns();
          arr.push({ ...s, id: `local-${Date.now()}` });
          localStorage.setItem('atkin_workshop_shutdowns', JSON.stringify(arr.map(x => x && ({...x, startDate:x.startDate.toISOString(), endDate:x.endDate.toISOString()})).filter(Boolean)));
          return;
        }
        const { collection, doc, setDoc } = this.api;
        const ref = doc(collection(this.db, "workshop_shutdowns"));
        await setDoc(ref, { ...s, id: ref.id });
      }

      async updateShutdown(id, partial) {
        if (!this.db) {
          const arr = await this.fetchWorkshopShutdowns();
          const i = arr.findIndex(x => x && x.id === id);
          if (i >= 0) {
            arr[i] = { ...arr[i], ...partial };
            localStorage.setItem('atkin_workshop_shutdowns', JSON.stringify(arr.map(x => x && ({...x, startDate:new Date(x.startDate).toISOString(), endDate:new Date(x.endDate).toISOString()})).filter(Boolean)));
          }
          return;
        }
        const { doc, setDoc } = this.api;
        await setDoc(doc(this.db, "workshop_shutdowns", String(id)), partial, { merge: true });
      }

      async deleteWorkshopShutdown(id) {
        if (!this.db) {
          const arr = (await this.fetchWorkshopShutdowns()).filter(x => x && x.id !== id);
          localStorage.setItem('atkin_workshop_shutdowns', JSON.stringify(arr.map(x => x && ({...x, startDate:x.startDate.toISOString(), endDate:x.endDate.toISOString()})).filter(Boolean)));
          return;
        }
        const { doc, deleteDoc } = this.api;
        await deleteDoc(doc(this.db, "workshop_shutdowns", String(id)));
      }
    }

    const LeaveCalendar = () => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [viewMode, setViewMode] = useState('month');
      const [showQuickLeaveModal, setShowQuickLeaveModal] = useState(false);
      const [showEmployeeModal, setShowEmployeeModal] = useState(false);
      const [selectedDate, setSelectedDate] = useState(null);
      const [editingEmployee, setEditingEmployee] = useState(null);
      const [connectionStatus, setConnectionStatus] = useState('connected');
      const [showConnectionIndicator, setShowConnectionIndicator] = useState(true);
      const [notifications, setNotifications] = useState([]);
      const [employees, setEmployees] = useState([]);
      const [leaveRequests, setLeaveRequests] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [showSidebar, setShowSidebar] = useState(false);
      const [currentView, setCurrentView] = useState('calendar');

      const [workshopShutdowns, setWorkshopShutdowns] = useState([]);
      const [shutdownForm, setShutdownForm] = useState({ name: '', startDate: '', endDate: '', description: '' });
      const [editingShutdown, setEditingShutdown] = useState(null);

      const [showDayDrawer, setShowDayDrawer] = useState(false);
      const [drawerDate, setDrawerDate] = useState(null);
      const [editingLeave, setEditingLeave] = useState(null);
      const [editLeaveForm, setEditLeaveForm] = useState({ employeeId:"", type:"", duration:"", startDate:"" });

      const addNotification = useCallback((message, type='info') => {
        const id = Date.now();
        setNotifications(prev => [...(prev || []), { id, message, type, show:false }]);
        setTimeout(() => setNotifications(prev => ((prev || []).filter(Boolean).map(n => n && (n.id === id ? { ...n, show:true } : n)))), 100);
        setTimeout(() => setNotifications(prev => (prev || []).filter(n => n && n.id !== id)), 5000);
      }, []);

      const [dbApi] = useState(() => new DatabaseAPI(addNotification));

      useEffect(() => {
        const onOnline = () => setConnectionStatus('connected');
        const onOffline = () => setConnectionStatus('disconnected');
        window.addEventListener('online', onOnline);
        window.addEventListener('offline', onOffline);
        return () => {
          window.removeEventListener('online', onOnline);
          window.removeEventListener('offline', onOffline);
        };
      }, []);

      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const getEasterDate = (year) => {
        const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),n=Math.floor((h+l-7*m+114)/31),p=(h+l-7*m+114)%31;
        return new Date(year,n-1,p+1);
      };
      const getFirstMondayOfMonth = (year, month) => {
        const first=new Date(year,month,1), dow=first.getDay(), daysUntilMonday=dow===0?1:8-dow;
        return new Date(year,month,1+daysUntilMonday);
      };
      const getLastMondayOfMonth = (year, month) => {
        const lastDay=new Date(year,month+1,0), dow=lastDay.getDay(), sub=dow===1?0:dow===0?6:dow-1;
        return new Date(year,month,lastDay.getDate()-sub);
      };
      const getBankHolidays = (year) => {
        const hs = [];
        hs.push({ name: "New Year's Day", date: new Date(year, 0, 1) });
        const easter = getEasterDate(year);
        const gf = new Date(easter);
        const em = new Date(easter);
        gf.setDate(easter.getDate() - 2);
        em.setDate(easter.getDate() + 1);
        hs.push({ name: "Good Friday", date: gf });
        hs.push({ name: "Easter Monday", date: em });
        hs.push({ name: "Early May Bank Holiday", date: getFirstMondayOfMonth(year, 4) });
        hs.push({ name: "Spring Bank Holiday", date: getLastMondayOfMonth(year, 4) });
        hs.push({ name: "Summer Bank Holiday", date: getLastMondayOfMonth(year, 7) });
        hs.push({ name: "Christmas Day", date: new Date(year, 11, 25) });
        hs.push({ name: "Boxing Day", date: new Date(year, 11, 26) });
        return hs;
      };

      const isSameDay = (a, b) => a.toDateString() === b.toDateString();
      const isBankHolidayDate = (date) =>
        getBankHolidays(date.getFullYear()).some(h => isSameDay(h.date, date));
      const isWeekendDay = (date) => date.getDay() === 0 || date.getDay() === 6;
      const isWorkingDay = (date) => !isWeekendDay(date) && !isBankHolidayDate(date);
      const nextWorkingDay = (date) => {
        const d = new Date(date);
        while (!isWorkingDay(d)) d.setDate(d.getDate() + 1);
        return d;
      };
      const addWorkingDays = (start, days) => {
        let d = nextWorkingDay(start);
        if (days <= 1) return d;
        let remaining = days - 1;
        while (remaining > 0) {
          d.setDate(d.getDate() + 1);
          if (isWorkingDay(d)) remaining--;
        }
        return d;
      };

      const [quickLeaveForm, setQuickLeaveForm] = useState({ employeeId: "", duration: "", type: "" });
      const [employeeForm, setEmployeeForm] = useState({ name: '', department: '', totalLeave: '160', usedLeave: '0', color: '#3B82F6' });
      const colorOptions = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#06B6D4'];

      const lengthShort = (leave) => {
        const h = leave.hours || 0;
        if (h === 8) return 'day';
        if (h % 8 === 0) return `${h/8}d`;
        return `${h}h`;
      };

      const formatHours = (h) => { const d=Math.floor(h/8), r=h%8; return r>0?`${d}d ${r}h`:`${d}d`; };
      const generateInitials = (name) => name.split(' ').map(w => w[0]).join('').toUpperCase().substring(0,2);

      const getMonthDays = () => {
        const y=currentDate.getFullYear(), m=currentDate.getMonth();
        const first=new Date(y,m,1); const start=new Date(first); start.setDate(start.getDate()-first.getDay());
        return Array.from({length:42},(_,i)=>new Date(start.getFullYear(),start.getMonth(),start.getDate()+i));
      };
      const getWeekDays = () => {
        const start=new Date(currentDate); const day=start.getDay(); start.setDate(currentDate.getDate()-day);
        return Array.from({length:7},(_,i)=>new Date(start.getFullYear(),start.getMonth(),start.getDate()+i));
      };
      const getCalendarDays = () => viewMode==='week'?getWeekDays():getMonthDays();
      const navigateCalendar = (dir) => setCurrentDate(prev => {
        const nd=new Date(prev);
        if (viewMode==='week') nd.setDate(prev.getDate()+dir*7);
        else nd.setMonth(prev.getMonth()+dir);
        return nd;
      });
      const getViewTitle = () => {
        if (viewMode==='week') {
          const s=new Date(currentDate); const day=s.getDay(); s.setDate(currentDate.getDate()-day);
          const e=new Date(s); e.setDate(s.getDate()+6);
          return (s.getMonth()===e.getMonth())
            ? `${monthNames[s.getMonth()]} ${s.getDate()}-${e.getDate()}, ${s.getFullYear()}`
            : `${monthNames[s.getMonth()]} ${s.getDate()} - ${monthNames[e.getMonth()]} ${e.getDate()}, ${s.getFullYear()}`;
        }
        return `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
      };
      const getStatusColor = (status) => {
        switch(status){
          case 'approved': return 'bg-green-100 text-green-800';
          case 'pending': return 'bg-yellow-100 text-yellow-800';
          case 'shutdown': return 'bg-red-100 text-red-800';
          case 'bankholiday': return 'bg-purple-100 text-purple-800';
          default: return 'bg-gray-100 text-gray-800';
        }
      };

      const getLeaveForDate = (date) => {
        const regs = (leaveRequests || []).filter(l => {
          if (!l) return false;
          const s = new Date(l.startDate), e = new Date(l.endDate);
          return date >= s && date <= e && isWorkingDay(date);
        });
        const shut = (workshopShutdowns || []).filter(s => s && date >= new Date(s.startDate) && date <= new Date(s.endDate))
          .map(s => ({
            id: `shutdown-${s.id}`,
            type: 'Workshop Shutdown',
            status: 'shutdown',
            isShutdown: true,
            name: s.name
          }));

        const res = [...regs, ...shut];
        if (!isWorkingDay(date) && isBankHolidayDate(date)) {
          const bh = getBankHolidays(date.getFullYear()).find(h => isSameDay(h.date, date));
          res.push({ id: `bankholiday-${bh.name.replace(/\s+/g,'-')}`, type: 'Bank Holiday', status: 'bankholiday', isBankHoliday: true, name: bh.name });
        }
        return res;
      };

      useEffect(() => {
        let unsubEmp = null, unsubLeave = null, unsubShut = null;
        const init = async () => {
          if (window.__fb?.ready) { await window.__fb.ready; }
          if (window.__fb?.db) {
            unsubEmp  = dbApi.subscribeEmployees(setEmployees);
            unsubLeave = dbApi.subscribeLeaveRequests(setLeaveRequests);
            unsubShut = dbApi.subscribeWorkshopShutdowns(setWorkshopShutdowns);
          } else {
            const [e,l,s] = await Promise.all([
              dbApi.fetchEmployees(), dbApi.fetchLeaveRequests(), dbApi.fetchWorkshopShutdowns()
            ]);
            setEmployees(e); setLeaveRequests(l); setWorkshopShutdowns(s);
            addNotification('Running in local (offline) mode.', 'error');
          }
          setIsLoading(false);
          setTimeout(() => setShowConnectionIndicator(false), 3000);
        };
        init();
        return () => { unsubEmp?.(); unsubLeave?.(); unsubShut?.(); };
      }, [dbApi]);

      // ---------- ACTIONS ----------
      const saveQuickLeave = async () => {
        if (!quickLeaveForm.employeeId || !quickLeaveForm.duration || !quickLeaveForm.type) {
          addNotification('Please complete all fields', 'error');
          return;
        }
        const employee = (employees || []).find(emp => emp && emp.id === parseInt(quickLeaveForm.employeeId));
        if (!employee) { addNotification('Please select a valid employee', 'error'); return; }

        const [unit, valueStr] = String(quickLeaveForm.duration).split(':');
        const n = Math.max(1, parseInt(valueStr || '1'));
        const isHours = unit === 'H';
        let start = nextWorkingDay(new Date(selectedDate));

        const toCreate = [];
        if (isHours) {
          toCreate.push({ employeeId: parseInt(quickLeaveForm.employeeId), startDate: new Date(start), endDate: new Date(start), type: quickLeaveForm.type, status: 'approved', hours: n });
        } else {
          let created = 0; const d = new Date(start);
          while (created < n) {
            if (isWorkingDay(d)) {
              toCreate.push({ employeeId: parseInt(quickLeaveForm.employeeId), startDate: new Date(d), endDate: new Date(d), type: quickLeaveForm.type, status: 'approved', hours: 8 });
              created++;
            }
            d.setDate(d.getDate() + 1);
          }
        }

        const nowBase = Date.now();
        setLeaveRequests(prev => [ ...(prev || []), ...toCreate.map((l, i) => ({ ...l, id: `tmp-${nowBase}-${i}` })) ]);

        const totalHours = toCreate.reduce((sum, x) => sum + (x.hours || 0), 0);
        if (quickLeaveForm.type !== 'In Lieu') {
          const changed = (employees || []).find(e => e && e.id === parseInt(quickLeaveForm.employeeId));
          if (changed) {
            const updated = { ...changed, usedLeave: (changed.usedLeave || 0) + totalHours };
            setEmployees(prev => ((prev || []).map(e => e && (e.id === updated.id ? updated : e))).filter(Boolean));
            await dbApi.upsertEmployee(updated);
          }
        }
        await Promise.all(toCreate.map(l => dbApi.createLeave(l)));
        setShowQuickLeaveModal(false);
        addNotification(isHours ? 'Leave (hours) added' : 'Leave (daily entries) added', 'success');
      };

      const saveEditedLeave = async () => {
        if (!editingLeave) return;
        const [unit, valueStr] = String(editLeaveForm.duration).split(':');
        const n = Math.max(1, parseInt(valueStr || '1'));
        const isHours = unit === 'H';
        const start = nextWorkingDay(new Date(editLeaveForm.startDate));

        const toCreate = [];
        if (isHours) {
          toCreate.push({ employeeId: parseInt(editLeaveForm.employeeId || editingLeave.employeeId), startDate: new Date(start), endDate: new Date(start), type: editLeaveForm.type, status: 'approved', hours: n });
        } else {
          let created = 0; const d = new Date(start);
          while (created < n) {
            if (isWorkingDay(d)) {
              toCreate.push({ employeeId: parseInt(editLeaveForm.employeeId || editingLeave.employeeId), startDate: new Date(d), endDate: new Date(d), type: editLeaveForm.type, status: 'approved', hours: 8 });
              created++;
            }
            d.setDate(d.getDate() + 1);
          }
        }

        const oldHours = editingLeave.hours || 0;
        const newTotalHours = toCreate.reduce((s, x) => s + (x.hours || 0), 0);
        const deltaHours = (editLeaveForm.type === 'In Lieu' ? 0 : newTotalHours) - (editingLeave.type === 'In Lieu' ? 0 : oldHours);

        setLeaveRequests(prev => {
          const filtered = (prev || []).filter(l => l && l.id !== editingLeave.id);
          const nowBase = Date.now();
          const temps = toCreate.map((l, i) => ({ ...l, id: `tmp-edit-${nowBase}-${i}` }));
          return [...filtered, ...temps];
        });

        if (deltaHours !== 0) {
          const empId = parseInt(editLeaveForm.employeeId || editingLeave.employeeId);
          const changed = (employees || []).find(e => e && e.id === empId);
          if (changed) {
            const updated = { ...changed, usedLeave: (changed.usedLeave || 0) + deltaHours };
            setEmployees(prev => ((prev || []).map(e => e && (e.id === updated.id ? updated : e))).filter(Boolean));
            await dbApi.upsertEmployee(updated);
          }
        }

        await dbApi.deleteLeaveRequest(editingLeave.id);
        await Promise.all(toCreate.map(l => dbApi.createLeave(l)));
        addNotification('Leave updated', 'success');
        setEditingLeave(null);
      };

      const saveEmployee = async () => {
        if (!employeeForm.name.trim() || !employeeForm.department.trim()) { addNotification('Please fill in all required fields', 'error'); return; }
        const totalLeave = parseInt(employeeForm.totalLeave) || 0;
        const usedLeave = parseInt(employeeForm.usedLeave) || 0;

        if (editingEmployee) {
          const updated = { ...editingEmployee, name: employeeForm.name, department: employeeForm.department, totalLeave, usedLeave, color: employeeForm.color, avatar: generateInitials(employeeForm.name) };
          await dbApi.upsertEmployee(updated);
          setShowEmployeeModal(false);
          setEditingEmployee(null);
          addNotification('Employee updated', 'success');
        } else {
          const nextId = Math.max(0, ...((employees || []).filter(Boolean).map(e => e.id||0))) + 1;
          const newEmp = { id: nextId, name: employeeForm.name, department: employeeForm.department, totalLeave, usedLeave, avatar: generateInitials(employeeForm.name), color: employeeForm.color };
          await dbApi.upsertEmployee(newEmp);
          setShowEmployeeModal(false);
          addNotification('Employee added', 'success');
        }
      };

      const deleteEmployee = async (employeeId) => {
        if (!confirm('Are you sure you want to delete this employee?')) return;
        await dbApi.deleteEmployee(employeeId);
        addNotification('Employee deleted', 'success');
      };

      const saveWorkshopShutdown = async () => {
        if (!shutdownForm.name.trim() || !shutdownForm.startDate || !shutdownForm.endDate) {
          addNotification('Please fill in all required fields', 'error');
          return;
        }
        const startDate = new Date(shutdownForm.startDate);
        const endDate = new Date(shutdownForm.endDate);
        if (endDate < startDate) { addNotification('End date must be after start date', 'error'); return; }

        if (editingShutdown) {
          await dbApi.updateShutdown(editingShutdown, { name: shutdownForm.name, startDate, endDate, description: shutdownForm.description });
          addNotification('Workshop shutdown updated', 'success');
          setEditingShutdown(null);
        } else {
          const newS = { name: shutdownForm.name, startDate, endDate, description: shutdownForm.description };
          await dbApi.createShutdown(newS);
          addNotification('Workshop shutdown added', 'success');
        }
        setShutdownForm({ name:'', startDate:'', endDate:'', description:'' });
      };

      const deleteWorkshopShutdown = async (shutdownId) => {
        if (!confirm('Are you sure you want to delete this workshop shutdown?')) return;
        await dbApi.deleteWorkshopShutdown(shutdownId);
        addNotification('Workshop shutdown deleted', 'success');
      };

      const openEmployeeModal = (employee=null) => {
        if (employee) {
          setEditingEmployee(employee);
          setEmployeeForm({ name: employee.name, department: employee.department, totalLeave: String(employee.totalLeave), usedLeave: String(employee.usedLeave), color: employee.color });
        } else {
          setEditingEmployee(null);
          setEmployeeForm({ name:'', department:'', totalLeave:'160', usedLeave:'0', color: colorOptions[(employees || []).length % colorOptions.length] });
        }
        setShowEmployeeModal(true);
      };

      const handleModeChange = (mode) => {
        setViewMode(mode);
        if (mode === 'week') setCurrentDate(new Date());
      };

      if (isLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-4 text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      const days = getCalendarDays();
      const addEnabled = quickLeaveForm.employeeId && quickLeaveForm.duration && quickLeaveForm.type;
      const currentYear = new Date().getFullYear();

      const usedHoursThisYearFor = (empId) =>
        (leaveRequests || [])
          .filter(l => l && l.employeeId === empId && l.type !== 'In Lieu' && new Date(l.startDate).getFullYear() === currentYear)
          .reduce((sum, l) => sum + (l.hours || 0), 0);

      const nextUpcomingFor = (empId) => {
        const today = new Date();
        const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const sorted = (leaveRequests || [])
          .filter(l => l && l.employeeId === empId && new Date(l.startDate) >= t0)
          .sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
        return sorted[0] || null;
      };

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Connection Status */}
          <div className={`connection-indicator ${connectionStatus} ${!showConnectionIndicator ? 'hide' : ''}`}>
            <Icon name={connectionStatus === 'connected' ? 'wifi' : 'wifiOff'} className="h-4 w-4" />
            <span>{connectionStatus === 'connected' ? (window.__fb?.db ? 'Cloud Sync On' : 'Offline Mode') : 'Offline'}</span>
          </div>

          {/* Notifications */}
          {(notifications || []).map(n => (
            <div key={n.id} className={`notification ${n.type} ${n.show ? 'show' : ''}`}>{n.message}</div>
          ))}

          {/* Header */}
          <div className="bg-white shadow-sm border-b">
            <div className="max-w-7xl mx:auto md:mx-auto px-6 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-4">
                  <button onClick={() => setShowSidebar(true)} className="p-2 hover:bg-gray-100 rounded-lg">
                    <Icon name="menu" className="h-6 w-6 text-gray-600" />
                  </button>
                  <div className="flex items-center space-x-2">
                    <Icon name="calendar" className="h-8 w-8 text-blue-600" />
                    <h1 className="text-2xl font-bold text-gray-900">
                      Atkin Guitars {currentView === 'settings' ? 'Settings' : 'Leave Calendar'}
                    </h1>
                  </div>
                </div>
                {currentView === 'calendar' && (
                  <div className="flex bg-gray-100 rounded-lg p-1">
                    {['week','month'].map(mode => (
                      <button key={mode} onClick={() => handleModeChange(mode)}
                        className={`px-3 py-1 rounded-md text-sm font-medium capitalize transition-colors ${viewMode === mode ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'}`}>
                        {mode}
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Main Content - Calendar View */}
          {currentView === 'calendar' && (
            <div className="max-w-7xl mx-auto px-6 py-8">
              <div className="bg-white rounded-xl shadow-sm border">
                <div className="flex items-center justify-between p-6 border-b">
                  <div className="flex items-center space-x-4">
                    <button onClick={() => navigateCalendar(-1)} className="p-2 hover:bg-gray-100 rounded-lg">←</button>
                    <h2 className="text-xl font-semibold text-gray-900">{getViewTitle()}</h2>
                    <button onClick={() => navigateCalendar(1)} className="p-2 hover:bg-gray-100 rounded-lg">→</button>
                  </div>
                </div>

                <div className="p-6">
                  <div>
                    <div className={`grid grid-cols-7 gap-1 mb-2`}>
                      {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => (
                        <div key={d} className="p-3 text-center text-sm font-medium text-gray-500">{d}</div>
                      ))}
                    </div>
                    <div className={`grid grid-cols-7 gap-1`}>
                      {days.map((date, idx) => {
                        const isCurrentMonth = date.getMonth()===currentDate.getMonth();
                        const isToday = date.toDateString() === new Date().toDateString();
                        const weekend = isWeekendDay(date);
                        const dayLeaves = getLeaveForDate(date);
                        return (
                          <div key={idx}
                               className={`min-h-[96px] p-2 border border-gray-200 hover:bg-gray-50 transition-colors relative group ${
                                 !isCurrentMonth ? 'bg-gray-50 text-gray-400' : ''} ${isToday ? 'bg-red-50 border-red-200' : ''} ${weekend ? 'bg-gray-100' : ''}`}>
                            <div className="flex justify-between items-start mb-1">
                              <button
                                onClick={() => { setDrawerDate(date); setShowDayDrawer(true); setEditingLeave(null); }}
                                className={`text-sm font-medium ${isToday ? 'text-red-600' : isCurrentMonth ? 'text-gray-900' : 'text-gray-400'} hover:underline cursor-pointer`}
                                title="Tap to expand day"
                              >
                                {date.getDate()}
                              </button>

                              {isCurrentMonth && isWorkingDay(date) && (
                                <span onClick={() => {
                                  setSelectedDate(date);
                                  setQuickLeaveForm({ employeeId:"", duration:"", type:"" });
                                  setShowQuickLeaveModal(true);
                                }} className="opacity-0 group-hover:opacity-100 w-5 h-5 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs hover:bg-blue-700 cursor-pointer">+</span>
                              )}
                            </div>

                            <div className="space-y-1">
                              {(dayLeaves || []).map(leave => {
                                if (!leave) return null;
                                if (leave.isShutdown) return <div key={leave.id} className={`text-xs px-2 py-1 rounded text-center truncate ${getStatusColor(leave.status)}`} title={leave.name}>Workshop Closed</div>;
                                if (leave.isBankHoliday) return <div key={leave.id} className={`text-xs px-2 py-1 rounded text-center truncate ${getStatusColor(leave.status)}`} title={leave.name}>Bank Holiday</div>;
                                const employee = (employees || []).find(e => e && e.id === leave.employeeId);
                                if (!employee) return null;
                                return (
                                  <div key={leave.id} className={`text-xs px-2 py-1 rounded text-center truncate flex items-center justify-between group ${getStatusColor(leave.status)}`} title={leave.type}>
                                    <span className="truncate flex-1">{employee.name.split(' ')[0]} <span className="opacity-70">• {lengthShort(leave)}</span></span>
                                    <button onClick={async () => {
                                      if (confirm(`Cancel leave for ${employee?.name}?`)) {
                                        await dbApi.deleteLeaveRequest(leave.id);
                                        addNotification('Leave removed', 'success');
                                      }
                                    }} className="opacity-0 group-hover:opacity-100 ml-1 p-0.5 hover:bg-red-200 rounded" title="Delete">
                                      <Icon name="x" className="h-2 w-2" />
                                    </button>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Settings View */}
          {currentView === 'settings' && (
            <div className="max-w-4xl mx-auto px-6 py-8">
              <div className="bg-white rounded-xl shadow-sm border p-6">
                <div className="mb-6">
                  <h2 className="text-2xl font-bold text-gray-900 mb-2">Workshop Settings</h2>
                  <p className="text-gray-600">Manage workshop shutdowns and other calendar settings</p>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Add / Edit Workshop Shutdown</h3>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Shutdown Name *</label>
                        <input type="text" value={shutdownForm.name}
                               onChange={(e) => setShutdownForm(prev => ({...prev, name: e.target.value}))}
                               className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., Christmas Break, Annual Maintenance" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Start Date *</label>
                        <input type="date" value={shutdownForm.startDate}
                               onChange={(e) => setShutdownForm(prev => ({...prev, startDate: e.target.value}))}
                               className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">End Date *</label>
                        <input type="date" value={shutdownForm.endDate}
                               onChange={(e) => setShutdownForm(prev => ({...prev, endDate: e.target.value}))}
                               className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea value={shutdownForm.description}
                                  onChange={(e) => setShutdownForm(prev => ({...prev, description: e.target.value}))}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  rows={3} placeholder="Optional description..." />
                      </div>
                      <div className="flex gap-3">
                        <button onClick={saveWorkshopShutdown}
                                className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                          {editingShutdown ? 'Update Workshop Shutdown' : 'Add Workshop Shutdown'}
                        </button>
                        {editingShutdown && (
                          <button
                            onClick={() => { setEditingShutdown(null); setShutdownForm({ name:'', startDate:'', endDate:'', description:'' }); }}
                            className="px-4 py-2 border rounded-lg hover:bg-gray-50"
                          >
                            Cancel
                          </button>
                        )}
                      </div>
                    </div>
                  </div>

                  <div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Existing Workshop Shutdowns</h3>
                    <div className="space-y-3">
                      {(workshopShutdowns || []).length === 0 ? (
                        <p className="text-gray-500 text-sm italic">No workshop shutdowns scheduled</p>
                      ) : (
                        (workshopShutdowns || []).filter(Boolean).map(shutdown => (
                          <div key={shutdown.id}
                               className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow relative group">
                            <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                              <button
                                onClick={() => {
                                  setEditingShutdown(shutdown.id);
                                  setShutdownForm({
                                    name: shutdown.name || '',
                                    startDate: new Date(shutdown.startDate).toISOString().slice(0,10),
                                    endDate: new Date(shutdown.endDate).toISOString().slice(0,10),
                                    description: shutdown.description || ''
                                  });
                                  window.scrollTo({ top: 0, behavior: 'smooth' });
                                }}
                                className="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                                title="Edit"
                              >
                                ✎
                              </button>
                              <button onClick={() => deleteWorkshopShutdown(shutdown.id)}
                                      className="p-1 text-gray-400 hover:text-red-600 transition-colors" title="Delete">
                                ✕
                              </button>
                            </div>
                            <div className="pr-16">
                              <h4 className="font-medium text-gray-900">{shutdown.name}</h4>
                              <p className="text-sm text-gray-600 mt-1">
                                {new Date(shutdown.startDate).toLocaleDateString()} - {new Date(shutdown.endDate).toLocaleDateString()}
                              </p>
                              {shutdown.description && <p className="text-sm text-gray-500 mt-2">{shutdown.description}</p>}
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Quick Leave Modal */}
          {showQuickLeaveModal && selectedDate && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">Quick Add Leave - {selectedDate.toLocaleDateString()}</h3>
                  <button onClick={() => setShowQuickLeaveModal(false)} className="text-gray-400 hover:text-gray-600">✕</button>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                    <select
                      value={quickLeaveForm.employeeId}
                      onChange={(e) => setQuickLeaveForm(prev => ({...prev, employeeId: e.target.value}))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">Select Employee</option>
                      {(employees || []).filter(Boolean).map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Number of Days/Hours</label>
                    <select
                      value={quickLeaveForm.duration}
                      onChange={(e) => setQuickLeaveForm(prev => ({...prev, duration: e.target.value}))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">Select Duration</option>
                      <optgroup label="Hours">
                        <option value="H:1">1 Hour</option>
                        <option value="H:2">2 Hours</option>
                        <option value="H:3">3 Hours</option>
                        <option value="H:4">4 Hours</option>
                        <option value="H:5">5 Hours</option>
                        <option value="H:6">6 Hours</option>
                        <option value="H:7">7 Hours</option>
                      </optgroup>
                      <optgroup label="Days">
                        <option value="D:1">1 Day (8 hours)</option>
                        <option value="D:2">2 Days (16 hours)</option>
                        <option value="D:3">3 Days (24 hours)</option>
                        <option value="D:4">4 Days (32 hours)</option>
                        <option value="D:5">5 Days (40 hours)</option>
                      </optgroup>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Leave Type</label>
                    <select
                      value={quickLeaveForm.type}
                      onChange={(e) => setQuickLeaveForm(prev => ({...prev, type: e.target.value}))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">Select Leave Type</option>
                      <option value="Annual Leave">Annual Leave</option>
                      <option value="In Lieu">In Lieu</option>
                    </select>
                  </div>
                  <div className="flex justify-end space-x-3 pt-4">
                    <button onClick={() => setShowQuickLeaveModal(false)} className="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button
                      onClick={saveQuickLeave}
                      disabled={!addEnabled}
                      className={`px-4 py-2 rounded-lg text-white ${addEnabled ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}`}
                    >
                      Add Leave
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Day Drawer */}
          {showDayDrawer && drawerDate && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/40" onClick={() => { setShowDayDrawer(false); setDrawerDate(null); setEditingLeave(null); }}></div>
              <div className="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-xl p-4 max-h-[80vh] overflow-y-auto">
                <div className="flex items-start justify-between mb-2">
                  <div>
                    <h3 className="text-lg font-semibold">
                      {drawerDate.toLocaleDateString(undefined, { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                    </h3>
                  </div>
                  <button className="text-gray-500" onClick={() => { setShowDayDrawer(false); setDrawerDate(null); setEditingLeave(null); }}>✕</button>
                </div>
                <div className="space-y-2">
                  {(getLeaveForDate(drawerDate) || []).filter(Boolean).map(leave => {
                    const employee = (employees || []).find(e => e && e.id === leave.employeeId);
                    if (!employee || leave.isShutdown || leave.isBankHoliday) return null;
                    return (
                      <div key={leave.id} className="border rounded-lg p-3 flex items-center justify-between">
                        <div className="text-sm">{employee.name} • {leave.type} • {lengthShort(leave)}</div>
                        <div className="flex gap-2">
                          <button className="px-2 py-1 text-xs border rounded" onClick={() => {
                            setEditingLeave(leave);
                            const dur = (leave.hours || 0) % 8 === 0 ? `D:${(leave.hours||0)/8}` : `H:${leave.hours||0}`;
                            setEditLeaveForm({ employeeId: String(leave.employeeId), type: leave.type, duration: dur, startDate: new Date(leave.startDate).toISOString().slice(0,10) });
                          }}>Edit</button>
                          <button className="px-2 py-1 text-xs border rounded" onClick={async () => {
                            if (confirm(`Cancel leave for ${employee?.name}?`)) {
                              await dbApi.deleteLeaveRequest(leave.id);
                              addNotification('Leave removed', 'success');
                            }
                          }}>Delete</button>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {editingLeave && (
                  <div className="mt-4 border rounded-lg p-3">
                    <h4 className="font-medium mb-2">Edit Leave</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Start Date</label>
                        <input type="date" value={editLeaveForm.startDate}
                               onChange={(e) => setEditLeaveForm(prev => ({...prev, startDate: e.target.value}))}
                               className="w-full px-2 py-1 border rounded" />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Duration</label>
                        <select value={editLeaveForm.duration}
                                onChange={(e) => setEditLeaveForm(prev => ({...prev, duration: e.target.value}))}
                                className="w-full px-2 py-1 border rounded">
                          <optgroup label="Hours">
                            <option value="H:1">1 Hour</option>
                            <option value="H:2">2 Hours</option>
                            <option value="H:3">3 Hours</option>
                            <option value="H:4">4 Hours</option>
                            <option value="H:5">5 Hours</option>
                            <option value="H:6">6 Hours</option>
                            <option value="H:7">7 Hours</option>
                          </optgroup>
                          <optgroup label="Days">
                            <option value="D:1">1 Day</option>
                            <option value="D:2">2 Days</option>
                            <option value="D:3">3 Days</option>
                            <option value="D:4">4 Days</option>
                            <option value="D:5">5 Days</option>
                          </optgroup>
                        </select>
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Type</label>
                        <select value={editLeaveForm.type}
                                onChange={(e) => setEditLeaveForm(prev => ({...prev, type: e.target.value}))}
                                className="w-full px-2 py-1 border rounded">
                          <option value="Annual Leave">Annual Leave</option>
                          <option value="In Lieu">In Lieu</option>
                        </select>
                      </div>
                    </div>
                    <div className="mt-3 flex gap-2 justify-end">
                      <button className="px-3 py-1 border rounded" onClick={() => setEditingLeave(null)}>Cancel</button>
                      <button className="px-3 py-1 bg-blue-600 text-white rounded" onClick={saveEditedLeave}>Save</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Sidebar overlay and nav */}
          <div className={`sidebar-overlay ${showSidebar ? 'show' : ''}`} onClick={() => setShowSidebar(false)} />
          <div className={`sidebar ${showSidebar ? 'open' : ''}`}>
            <div className="p-6">
              <div className="flex items-center justify-between mb-8">
                <h2 className="text-lg font-bold text-gray-900">Menu</h2>
                <button onClick={() => setShowSidebar(false)} className="p-1 hover:bg-gray-100 rounded">✕</button>
              </div>
              <nav className="space-y-2">
                <button onClick={() => { setCurrentView('calendar'); setShowSidebar(false); }}
                        className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left ${currentView === 'calendar' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                  <span>Calendar</span>
                </button>
                <button onClick={() => { setCurrentView('settings'); setShowSidebar(false); }}
                        className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-left ${currentView === 'settings' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                  <span>Settings</span>
                </button>
              </nav>
            </div>
          </div>
        </div>
      );
    };

    const App = () => <LeaveCalendar />;
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
