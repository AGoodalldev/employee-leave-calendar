<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atkin Guitars Leave Calendar</title>
  <link rel="icon" href="data:,">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s; z-index: 1000; }
    .sidebar.open { transform: translateX(0); }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .sidebar-overlay.show { opacity: 1; visibility: visible; }
    .notification { position: fixed; top: 80px; right: 20px; z-index: 1000; padding: 12px 16px; border-radius: 8px; color: white; transform: translateX(100%); transition: transform 0.3s; }
    .notification.show { transform: translateX(0); }
    .notification.success { background-color: #10B981; }
    .notification.error { background-color: #EF4444; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- App code -->
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    const Icon = ({ name, className }) => {
      const paths = {
        menu: "M4 6h16M4 12h16M4 18h16",
        calendar: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
        x: "M6 18L18 6M6 6l12 12",
        chevronLeft: "M15 19l-7-7 7-7",
        edit: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
        trash: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
      };
      return (
        <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={paths[name]} />
        </svg>
      );
    };

    // ---- Helpers: dates & bank holidays (UK generic incl. Easter) ----
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    const easter = (Y) => {
      const a = Y % 19;
      const b = Math.floor(Y / 100);
      const c = Y % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const L = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * L) / 451);
      const month = Math.floor((h + L - 7 * m + 114) / 31); // 3=March, 4=April
      const day = ((h + L - 7 * m + 114) % 31) + 1;
      return new Date(Y, month - 1, day);
    };

    const bankHolidays = (year) => {
      const E = easter(year);
      const goodFriday = new Date(E); goodFriday.setDate(E.getDate() - 2);
      const easterMon  = new Date(E); easterMon.setDate(E.getDate() + 1);
      const firstMonday = (m) => {
        const d = new Date(year, m, 1);
        const dow = d.getDay();
        const add = dow === 0 ? 1 : (dow === 1 ? 0 : (8 - dow));
        d.setDate(d.getDate() + add);
        return d;
      };
      const lastMonday = (m) => {
        const d = new Date(year, m + 1, 0); // last day of month
        const dow = d.getDay();
        const sub = dow === 1 ? 0 : (dow === 0 ? 6 : (dow - 1));
        d.setDate(d.getDate() - sub);
        return d;
      };
      return [
        { name: "New Year's Day", date: new Date(year, 0, 1) },
        { name: "Good Friday", date: goodFriday },
        { name: "Easter Monday", date: easterMon },
        { name: "Early May Bank Holiday", date: firstMonday(4) },  // May
        { name: "Spring Bank Holiday", date: lastMonday(4) },      // May
        { name: "Summer Bank Holiday", date: lastMonday(7) },      // Aug
        { name: "Christmas Day", date: new Date(year, 11, 25) },
        { name: "Boxing Day", date: new Date(year, 11, 26) },
      ];
    };

    const isSameDay = (a,b) => a.toDateString() === b.toDateString();
    const isWeekend = (d) => d.getDay() === 0 || d.getDay() === 6;
    const isBankHoliday = (d) => bankHolidays(d.getFullYear()).some(h => isSameDay(h.date, d));
    const isWorkingDay = (d) => !isWeekend(d) && !isBankHoliday(d);

    const nextWorkingDay = (d0) => {
      const d = new Date(d0);
      while (!isWorkingDay(d)) d.setDate(d.getDate() + 1);
      return d;
    };

    const addWorkingDays = (start, days) => {
      let d = nextWorkingDay(start);
      if (days <= 1) return d;
      let remaining = days - 1;
      while (remaining > 0) {
        d.setDate(d.getDate() + 1);
        if (isWorkingDay(d)) remaining--;
      }
      return d;
    };

    // ---- LOCAL STORAGE DB (kept from baseline UI to avoid Firebase dependency here) ----
    const LocalDB = {
      fetchEmployees: async () => {
        const raw = localStorage.getItem('atkin_employees');
        if (raw) return JSON.parse(raw);
        const seed = [
          { id: 1, name: 'Andy Goodall', department: 'CNC', totalLeave: 128, usedLeave: 0, color: '#EF4444', avatar: 'AG' },
        ];
        localStorage.setItem('atkin_employees', JSON.stringify(seed));
        return seed;
      },
      upsertEmployee: async (emp) => {
        const arr = await LocalDB.fetchEmployees();
        const i = arr.findIndex(e => e.id === emp.id);
        if (i >= 0) arr[i] = emp; else arr.push(emp);
        localStorage.setItem('atkin_employees', JSON.stringify(arr));
      },
      fetchLeaves: async () => {
        const raw = localStorage.getItem('atkin_leaves');
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return arr.map(r => ({ ...r, startDate: new Date(r.startDate), endDate: new Date(r.endDate) }));
      },
      saveLeaves: async (rows) => {
        const arr = rows.map(r => ({ ...r, startDate: r.startDate.toISOString(), endDate: r.endDate.toISOString() }));
        localStorage.setItem('atkin_leaves', JSON.stringify(arr));
      },
      createLeave: async (leave) => {
        const arr = await LocalDB.fetchLeaves();
        arr.push({ ...leave, id: `local-${Date.now()}-${Math.random().toString(36).slice(2,7)}` });
        await LocalDB.saveLeaves(arr);
      },
      updateLeave: async (id, patch) => {
        const arr = await LocalDB.fetchLeaves();
        const i = arr.findIndex(r => r.id === id);
        if (i >= 0) {
          arr[i] = { ...arr[i], ...patch };
          await LocalDB.saveLeaves(arr);
        }
      },
      deleteLeave: async (id) => {
        const arr = await LocalDB.fetchLeaves();
        const next = arr.filter(r => r.id !== id);
        await LocalDB.saveLeaves(next);
      },
      fetchShutdowns: async () => {
        const raw = localStorage.getItem('atkin_shutdowns');
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return arr.map(s => ({ ...s, startDate: new Date(s.startDate), endDate: new Date(s.endDate) }));
      },
      saveShutdowns: async (rows) => {
        const arr = rows.map(s => ({ ...s, startDate: s.startDate.toISOString(), endDate: s.endDate.toISOString() }));
        localStorage.setItem('atkin_shutdowns', JSON.stringify(arr));
      },
      createShutdown: async (s) => {
        const arr = await LocalDB.fetchShutdowns();
        arr.push({ ...s, id: `sd-${Date.now()}` });
        await LocalDB.saveShutdowns(arr);
      },
      deleteShutdown: async (id) => {
        const arr = await LocalDB.fetchShutdowns();
        const next = arr.filter(s => s.id !== id);
        await LocalDB.saveShutdowns(next);
      }
    };

    // ---- Main App ----
    const App = () => {
      const [employees, setEmployees] = useState([]);
      const [leaves, setLeaves] = useState([]);
      const [shutdowns, setShutdowns] = useState([]);

      const [currentDate, setCurrentDate] = useState(new Date());
      const [viewMode, setViewMode] = useState('month'); // week | month
      const [selectedDate, setSelectedDate] = useState(null);
      const [showQuick, setShowQuick] = useState(false);

      const [notifications, setNotifications] = useState([]);

      const addNotification = useCallback((message, type='success') => {
        const id = Date.now();
        setNotifications(prev => [...prev, { id, message, type, show:false }]);
        setTimeout(() => setNotifications(prev => prev.map(n => n.id === id ? { ...n, show:true } : n)), 50);
        setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 4000);
      }, []);

      // ---- init ----
      useEffect(() => {
        (async () => {
          const [e, l, s] = await Promise.all([
            LocalDB.fetchEmployees(), LocalDB.fetchLeaves(), LocalDB.fetchShutdowns()
          ]);
          setEmployees(e); setLeaves(l); setShutdowns(s);
        })();
      }, []);

      // ---- helpers for effective (exclusions-aware) hours ----
      const isDateExcluded = (leave, d) => {
        if (!leave.exclusions) return false;
        return (leave.exclusions || []).some(x => isSameDay(new Date(x), d));
      };

      const effectiveHoursOnDay = (leave, d) => {
        // If the day is outside the range, 0
        if (d < leave.startDate || d > leave.endDate) return 0;
        // If exclusion for that day, 0
        if (isDateExcluded(leave, d)) return 0;
        // If non-working day, 0
        if (!isWorkingDay(d)) return 0;
        // Hours for the block: assume full-day chunks unless stored as explicit hours (<=7)
        // If leave.hours is multiple of 8, each covered working day contributes 8h.
        // If leave.hours <= 7, treat as those hours on the FIRST working day only.
        const total = leave.hours || 0;
        if (total <= 7) {
          // single-day hours: only count on the first working day
          const first = nextWorkingDay(new Date(leave.startDate));
          return isSameDay(first, d) ? total : 0;
        }
        // multi-day
        return 8;
      };

      // Used hours this year (excluding weekends, BH, exclusions)
      const currentYear = new Date().getFullYear();
      const usedHoursThisYearFor = (empId) => {
        let sum = 0;
        leaves.forEach(l => {
          if (l.employeeId !== empId) return;
          if (new Date(l.startDate).getFullYear() !== currentYear) return;
          // iterate days
          const cur = new Date(l.startDate);
          while (cur <= l.endDate) {
            sum += effectiveHoursOnDay(l, cur);
            cur.setDate(cur.getDate() + 1);
          }
        });
        return sum;
      };

      const formatHoursCompact = (h) => {
        const d = Math.floor(h/8), r = h%8;
        if (d && r) return `${d}d ${r}h`;
        if (d) return `${d}d`;
        return `${r}h`;
      };

      // ---- calendar building ----
      const getMonthDays = () => {
        const y=currentDate.getFullYear(), m=currentDate.getMonth();
        const first=new Date(y,m,1); const start=new Date(first);
        start.setDate(start.getDate()-first.getDay());
        return Array.from({length:42},(_,i)=>new Date(start.getFullYear(),start.getMonth(),start.getDate()+i));
      };

      const days = useMemo(() => getMonthDays(), [currentDate, viewMode]);

      const leavesOnDate = (d) => {
        // Return list of leaves that yield >0 effective hours that date
        return leaves.filter(l => effectiveHoursOnDay(l, d) > 0);
      };

      const shutdownOnDate = (d) => shutdowns.some(s => d >= s.startDate && d <= s.endDate);

      const isBookableDay = (d) => isWorkingDay(d) && !shutdownOnDate(d);

      // ---- Quick add form ----
      const [quick, setQuick] = useState({ employeeId: "", duration: "", type: "" });

      const openQuickFor = (d) => {
        setSelectedDate(d);
        setQuick({ employeeId:"", duration:"", type:"" });
        setShowQuick(true);
      };

      const saveQuickLeave = async () => {
        if (!quick.employeeId || !quick.duration || !quick.type) {
          addNotification('Please complete all fields', 'error'); return;
        }
        const emp = employees.find(e => e.id === parseInt(quick.employeeId));
        if (!emp) { addNotification('Please select a valid employee', 'error'); return; }

        const [unit, valueStr] = String(quick.duration).split(':');
        const n = Math.max(1, parseInt(valueStr || '1'));
        const isHours = unit === 'H';

        // guard non-bookable start
        const startBase = nextWorkingDay(new Date(selectedDate));
        if (!isBookableDay(startBase)) {
          addNotification('Selected date is not bookable (weekend/bank holiday/shutdown)', 'error');
          return;
        }

        const start = new Date(startBase);
        const end = isHours ? new Date(start) : addWorkingDays(start, n);
        const totalHours = isHours ? n : n * 8;

        // Over-allocation warning
        const used = usedHoursThisYearFor(emp.id);
        const remaining = Math.max(0, (emp.totalLeave || 0) - used);
        if (quick.type !== 'In Lieu' && totalHours > remaining) {
          const ok = confirm(`This booking exceeds remaining balance by ${formatHoursCompact(totalHours - remaining)}. Continue?`);
          if (!ok) return;
        }

        const newLeave = {
          id: `tmp-${Date.now()}`,
          employeeId: emp.id,
          startDate: start,
          endDate: end,
          type: quick.type,
          status: 'approved',
          hours: totalHours,
          exclusions: [] // allow day removals later
        };

        // optimistic add
        setLeaves(prev => [...prev, newLeave]);
        await LocalDB.createLeave(newLeave);

        // bump usedLeave stored figure for display parity (optional)
        const updated = { ...emp, usedLeave: (emp.usedLeave || 0) + totalHours };
        setEmployees(prev => prev.map(e => e.id === updated.id ? updated : e));
        await LocalDB.upsertEmployee(updated);

        setShowQuick(false);
        addNotification('Leave added', 'success');
      };

      // ---- Day drawer ----
      const [showDrawer, setShowDrawer] = useState(false);
      const [drawerDate, setDrawerDate] = useState(null);

      const openDrawer = (d) => { setDrawerDate(d); setShowDrawer(true); };
      const closeDrawer = () => { setShowDrawer(false); setDrawerDate(null); };

      const perDayText = (leave, d) => {
        const h = effectiveHoursOnDay(leave, d);
        if (h === 8) return 'Full Day';
        if (h === 4) return 'Half Day';
        if (h > 0) return `${h}h`;
        return '0h';
        };

      const removeDateFromBlock = async (leave, d) => {
        // toggle exclusion for that date; if all days excluded, delete the leave
        const ex = new Set((leave.exclusions || []).map(x => new Date(x).toDateString()));
        const key = d.toDateString();
        if (ex.has(key)) ex.delete(key); else ex.add(key);
        const nextEx = Array.from(ex).map(s => new Date(s));

        // compute remaining effective hours; if 0 remove leave
        let remaining = 0;
        const cur = new Date(leave.startDate);
        while (cur <= leave.endDate) {
          const tmp = { ...leave, exclusions: nextEx };
          remaining += effectiveHoursOnDay(tmp, cur);
          cur.setDate(cur.getDate() + 1);
        }

        if (remaining <= 0) {
          // delete
          setLeaves(prev => prev.filter(l => l.id !== leave.id));
          await LocalDB.deleteLeave(leave.id);
          addNotification('Leave block removed', 'success');
        } else {
          // update
          const updated = { ...leave, exclusions: nextEx, hours: remaining };
          setLeaves(prev => prev.map(l => l.id === leave.id ? updated : l));
          await LocalDB.updateLeave(leave.id, { exclusions: nextEx, hours: remaining });
          addNotification('Day exclusion updated', 'success');
        }
      };

      // ---- UI helpers ----
      const compactName = (full) => full.split(' ')[0];

      // De-dup chips: only one chip per employee per date; skip if 0h on that day
      const chipsForDate = (d) => {
        const byId = new Map();
        leaves.forEach(l => {
          const h = effectiveHoursOnDay(l, d);
          if (h <= 0) return;
          const id = l.employeeId;
          if (!byId.has(id)) byId.set(id, l);
        });
        return Array.from(byId.values());
      };

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Notifications */}
          {notifications.map(n => (
            <div key={n.id} className={`notification ${n.type} ${n.show ? 'show' : ''}`}>{n.message}</div>
          ))}

          {/* Header */}
          <div className="bg-white shadow-sm border-b">
            <div className="max-w-7xl mx:auto md:mx-auto px-6 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-2">
                  <Icon name="calendar" className="h-7 w-7 text-blue-600" />
                  <h1 className="text-2xl font-bold text-gray-900">Atkin Guitars Leave Calendar</h1>
                </div>
                <div className="flex bg-gray-100 rounded-lg p-1">
                  {['week','month'].map(mode => (
                    <button key={mode} onClick={() => setViewMode(mode)}
                      className={`px-3 py-1 rounded-md text-sm font-medium capitalize transition-colors ${viewMode === mode ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'}`}>
                      {mode}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-6 py-8">
            <div className="bg-white rounded-xl shadow-sm border">
              <div className="flex items-center justify-between p-6 border-b">
                <div className="flex items-center space-x-4">
                  <button onClick={() => setCurrentDate(prev => { const nd=new Date(prev); nd.setMonth(prev.getMonth()-1); return nd; })} className="p-2 hover:bg-gray-100 rounded-lg">←</button>
                  <h2 className="text-xl font-semibold text-gray-900">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
                  <button onClick={() => setCurrentDate(prev => { const nd=new Date(prev); nd.setMonth(prev.getMonth()+1); return nd; })} className="p-2 hover:bg-gray-100 rounded-lg">→</button>
                </div>
              </div>

              <div className="p-6">
                <div className="grid grid-cols-7 gap-1 mb-2">
                  {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => (
                    <div key={d} className="p-3 text-center text-sm font-medium text-gray-500">{d}</div>
                  ))}
                </div>

                <div className="grid grid-cols-7 gap-1">
                  {days.map((date, idx) => {
                    const isCurrentMonth = date.getMonth()===currentDate.getMonth();
                    const isToday = date.toDateString() === new Date().toDateString();
                    const weekend = isWeekend(date);
                    const isPink = !isBookableDay(date) && isCurrentMonth;
                    const chips = chipsForDate(date);

                    return (
                      <div key={idx}
                        className={`min-h-[96px] p-2 border border-gray-200 hover:bg-gray-50 transition-colors relative group ${
                          !isCurrentMonth ? 'bg-gray-50 text-gray-400' : ''} ${isToday ? 'bg-red-50 border-red-200' : ''} ${weekend ? 'bg-gray-100' : ''} ${isPink ? 'bg-red-50 border-red-200' : ''}`}>
                        <div className="flex justify-between items-start mb-1">
                          <button onClick={() => openDrawer(date)} className={`text-sm font-medium ${isToday ? 'text-red-600' : isCurrentMonth ? 'text-gray-900' : 'text-gray-400'} hover:underline`}>
                            {date.getDate()}
                          </button>

                          {isCurrentMonth && isBookableDay(date) && (
                            <span onClick={() => openQuickFor(date)}
                              className="opacity-0 group-hover:opacity-100 w-5 h-5 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs hover:bg-blue-700 cursor-pointer">+</span>
                          )}
                        </div>

                        <div className="space-y-1">
                          {chips.map(leave => {
                            const emp = employees.find(e => e.id === leave.employeeId);
                            if (!emp) return null;
                            // Show only the first name (name-only chips), no duration
                            return (
                              <div key={leave.id} className="text-xs px-2 py-1 rounded text-center truncate bg-green-100 text-green-800">
                                {compactName(emp.name)}
                              </div>
                            );
                          })}
                          {isBankHoliday(date) && <div className="text-xs px-2 py-1 rounded text-center truncate bg-purple-100 text-purple-800">Bank Holiday</div>}
                          {shutdownOnDate(date) && <div className="text-xs px-2 py-1 rounded text-center truncate bg-red-100 text-red-800">Workshop Closed</div>}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          {/* Quick Add Modal */}
          {showQuick && selectedDate && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">Quick Add Leave - {selectedDate.toLocaleDateString()}</h3>
                  <button onClick={() => setShowQuick(false)} className="text-gray-400 hover:text-gray-600">✕</button>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                    <select value={quick.employeeId} onChange={(e) => setQuick(prev => ({...prev, employeeId: e.target.value}))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                      <option value="">Select Employee</option>
                      {employees.map(emp => <option key={emp.id} value={emp.id}>{emp.name}</option>)}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Number of Days/Hours</label>
                    <select value={quick.duration} onChange={(e) => setQuick(prev => ({...prev, duration: e.target.value}))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                      <option value="">Select Duration</option>
                      <optgroup label="Hours">
                        <option value="H:1">1 Hour</option>
                        <option value="H:2">2 Hours</option>
                        <option value="H:3">3 Hours</option>
                        <option value="H:4">4 Hours (Half Day)</option>
                        <option value="H:5">5 Hours</option>
                        <option value="H:6">6 Hours</option>
                        <option value="H:7">7 Hours</option>
                      </optgroup>
                      <optgroup label="Days">
                        <option value="D:1">1 Day (8 hours)</option>
                        <option value="D:2">2 Days (16 hours)</option>
                        <option value="D:3">3 Days (24 hours)</option>
                        <option value="D:4">4 Days (32 hours)</option>
                        <option value="D:5">5 Days (40 hours)</option>
                      </optgroup>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Leave Type</label>
                    <select value={quick.type} onChange={(e) => setQuick(prev => ({...prev, type: e.target.value}))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                      <option value="">Select Leave Type</option>
                      <option value="Annual Leave">Annual Leave</option>
                      <option value="In Lieu">In Lieu</option>
                    </select>
                  </div>

                  <div className="flex justify-end space-x-3 pt-2">
                    <button onClick={() => setShowQuick(false)} className="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button onClick={saveQuickLeave}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                      Add Leave
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Day Drawer */}
          {showDrawer && drawerDate && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/40" onClick={closeDrawer}></div>
              <div className="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-xl p-4 max-h-[80vh] overflow-y-auto">
                <div className="flex items-start justify-between mb-2">
                  <div>
                    <h3 className="text-lg font-semibold">
                      {drawerDate.toLocaleDateString(undefined, { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                    </h3>
                    {!isWorkingDay(drawerDate) && (
                      <p className="text-sm text-gray-500">Non-working day</p>
                    )}
                  </div>
                  <button onClick={closeDrawer} className="p-2 rounded hover:bg-gray-100">
                    <Icon name="x" className="h-5 w-5 text-gray-600" />
                  </button>
                </div>

                <div className="mb-3">
                  {isBookableDay(drawerDate) ? (
                    <button onClick={() => { setSelectedDate(drawerDate); setShowDrawer(false); setTimeout(()=>setShowQuick(true), 0); }}
                            className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                      Add Leave
                    </button>
                  ) : (
                    <span className="text-sm text-gray-500">This day is not bookable</span>
                  )}
                </div>

                <div className="space-y-3">
                  {(() => {
                    const items = leavesOnDate(drawerDate);
                    if (items.length === 0) return <div className="text-sm text-gray-500">No entries.</div>;
                    return items.map(item => {
                      const emp = employees.find(e => e.id === item.employeeId);
                      const label = perDayText(item, drawerDate);
                      return (
                        <div key={item.id} className="p-3 rounded-lg border border-gray-200">
                          <div className="flex items-center justify-between">
                            <div>
                              <div className="font-medium text-gray-900">{emp?.name || 'Employee'}</div>
                              <div className="text-sm text-gray-600">{item.type} • {label}</div>
                            </div>
                            <div className="flex gap-2">
                              <button className="px-2 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200"
                                      onClick={() => removeDateFromBlock(item, drawerDate)}>Exclude this day</button>
                              <button className="px-2 py-1 text-sm rounded bg-red-600 text-white hover:bg-red-700"
                                      onClick={async () => { await LocalDB.deleteLeave(item.id); setLeaves(prev => prev.filter(l => l.id !== item.id)); addNotification('Leave removed', 'success'); }}>Delete block</button>
                            </div>
                          </div>
                        </div>
                      );
                    });
                  })()}
                </div>
              </div>
            </div>
          )}

        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
