<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atkin Guitars Leave Calendar – Auth + Roles</title>
  <link rel="icon" href="data:,">

  <!-- React / Tailwind / Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <!-- Firebase module shim (attaches firebase exports to window.firebaseExports) -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- App (JSX via Babel) -->
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    // Pull modular Firebase APIs from window (set by firebase-init.js)
    const {
      initializeApp, getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut,
      getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, onSnapshot
    } = window.firebaseExports || {};

    // --- CONFIG: replace with your Firebase values ---
    const firebaseConfig = {
  apiKey: "AIzaSyD8zcVQBrK_Q_WQZKa856u2ka901eakX0A",
  authDomain: "atkin-guitars-94dd8.firebaseapp.com",
  projectId: "atkin-guitars-94dd8",
  storageBucket: "atkin-guitars-94dd8.firebasestorage.app",
  messagingSenderId: "501290829079",
  appId: "1:501290829079:web:e6d21711bccb47654ae352"
};

    // Initialize Firebase once (guard against double init)
    let firebaseApp = null;
    if (!window.__FB_APP__) {
      firebaseApp = initializeApp(firebaseConfig);
      window.__FB_APP__ = firebaseApp;
    } else {
      firebaseApp = window.__FB_APP__;
    }

    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    // --- Helpers ---
    async function ensureUserDoc(user) {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          role: "employee", // default role
          displayName: user.displayName || "",
          email: user.email || "",
          createdAt: new Date().toISOString(),
        });
      }
      const fresh = await getDoc(ref);
      return fresh.data();
    }

    function useAuth() {
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsub = onAuthStateChanged(auth, async (u) => {
          if (u) {
            const p = await ensureUserDoc(u);
            setUser(u);
            setProfile(p);
          } else {
            setUser(null);
            setProfile(null);
          }
          setLoading(false);
        });
        return () => unsub();
      }, []);

      return { user, profile, loading };
    }

    function Badge({ children }) {
      return (
        <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium bg-white shadow-sm">
          {children}
        </span>
      );
    }

    // --- UI: Login Page ---
    function LoginPage() {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [mode, setMode] = useState("signin"); // 'signin' | 'signup'
      const [err, setErr] = useState("");

      const googleSignIn = async () => {
        setErr("");
        try {
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
        } catch (e) {
          setErr(e.message);
        }
      };

      const emailFlow = async (e) => {
        e.preventDefault();
        setErr("");
        try {
          if (mode === "signin") {
            await signInWithEmailAndPassword(auth, email.trim(), password);
          } else {
            await createUserWithEmailAndPassword(auth, email.trim(), password);
          }
        } catch (e) {
          setErr(e.message);
        }
      };

      return (
        <div className="min-h-screen grid place-items-center p-4">
          <div className="w-full max-w-md bg-white rounded-2xl shadow p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h1 className="text-xl font-semibold">Atkin Leave Calendar</h1>
              <Badge>Auth & Roles</Badge>
            </div>

            <div className="flex gap-2 bg-slate-100 rounded-lg p-1">
              <button
                onClick={() => setMode("signin")}
                className={`flex-1 rounded-md py-2 text-sm ${mode==='signin'?'bg-white shadow font-medium':'text-slate-600'}`}
              >Sign in</button>
              <button
                onClick={() => setMode("signup")}
                className={`flex-1 rounded-md py-2 text-sm ${mode==='signup'?'bg-white shadow font-medium':'text-slate-600'}`}
              >Create account</button>
            </div>

            <form onSubmit={emailFlow} className="space-y-3">
              <div>
                <label className="block text-sm font-medium">Email</label>
                <input value={email} onChange={e=>setEmail(e.target.value)} type="email" required
                  className="mt-1 w-full rounded-lg border px-3 py-2 outline-none focus:ring focus:ring-slate-200" />
              </div>
              <div>
                <label className="block text-sm font-medium">Password</label>
                <input value={password} onChange={e=>setPassword(e.target.value)} type="password" required
                  className="mt-1 w-full rounded-lg border px-3 py-2 outline-none focus:ring focus:ring-slate-200" />
              </div>
              <button type="submit" className="w-full rounded-lg bg-black text-white py-2 font-medium hover:opacity-90">
                {mode === "signin" ? "Sign in" : "Create account"}
              </button>
            </form>

            <div className="relative">
              <div className="absolute inset-0 flex items-center"><span className="w-full border-t"></span></div>
              <div className="relative flex justify-center text-xs uppercase">
                <span className="bg-white px-2 text-slate-500">Or</span>
              </div>
            </div>

            <button onClick={googleSignIn} className="w-full rounded-lg border py-2 font-medium hover:bg-slate-50">
              Continue with Google
            </button>

            {err && <p className="text-sm text-red-600 mt-2">{err}</p>}
            <p className="text-xs text-slate-500">By continuing, you agree to the company policy.</p>
          </div>
        </div>
      );
    }

    // --- UI: Top Bar ---
    function TopBar({ user, role }) {
      return (
        <div className="sticky top-0 z-10 bg-white border-b px-4 py-2 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="font-semibold">Atkin Leave Calendar</span>
            <Badge>{role || "…"}</Badge>
          </div>
          <div className="flex items-center gap-3">
            <span className="text-sm text-slate-600">{user?.email}</span>
            <button onClick={()=>signOut(auth)} className="rounded-lg border px-3 py-1.5 text-sm hover:bg-slate-50">Sign out</button>
          </div>
        </div>
      );
    }

    // --- Demo Calendar Stub (replace with your full calendar) ---
    function CalendarStub({ user, role }) {
      const [requests, setRequests] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [err, setErr] = React.useState("");

      useEffect(() => {
        setErr("");
        setLoading(true);
        let qref;
        if (role === "manager") {
          qref = query(collection(db, "leaveRequests"));
        } else {
          qref = query(collection(db, "leaveRequests"), where("userId", "==", user.uid));
        }
        const unsub = onSnapshot(qref, (snap) => {
          const rows = [];
          snap.forEach(docSnap => rows.push({ id: docSnap.id, ...docSnap.data() }));
          setRequests(rows);
          setLoading(false);
        }, (e) => { setErr(e.message); setLoading(false); });
        return () => unsub();
      }, [user?.uid, role]);

      const createDemo = async () => {
        try {
          await addDoc(collection(db, "leaveRequests"), {
            userId: user.uid,
            createdAt: new Date().toISOString(),
            duration: "D:1",
            type: "Annual Leave",
            status: "pending",
          });
        } catch (e) {
          alert(e.message);
        }
      };

      return (
        <div className="p-4 space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold">Leave Requests</h2>
            <div className="flex gap-2">
              <button onClick={createDemo} className="rounded-lg bg-black text-white px-3 py-1.5 text-sm hover:opacity-90">
                + New (demo)
              </button>
            </div>
          </div>

          {loading && <p className="text-sm text-slate-600">Loading…</p>}
          {err && <p className="text-sm text-red-600">{err}</p>}

          <div className="grid gap-2">
            {requests.map(r => (
              <div key={r.id} className="rounded-xl border bg-white p-3 flex items-center justify-between">
                <div className="text-sm">
                  <div className="font-medium">{r.type} <span className="text-slate-500">({r.duration})</span></div>
                  <div className="text-slate-500">By: {r.userId}</div>
                </div>
                <Badge>{r.status}</Badge>
              </div>
            ))}
            {!loading && requests.length === 0 && (
              <p className="text-sm text-slate-500">No requests yet.</p>
            )}
          </div>
        </div>
      );
    }

    // --- Manager Panel (placeholder) ---
    function ManagerPanel({ role }) {
      if (role !== "manager") return null;
      return (
        <div className="mx-4 mb-4 rounded-xl border bg-white p-3">
          <div className="text-sm flex items-center justify-between">
            <div className="font-medium">Manager Tools</div>
            <span className="text-slate-500">Approve/deny logic can be wired to Firestore updates</span>
          </div>
        </div>
      );
    }

    function App() {
      const { user, profile, loading } = useAuth();

      if (loading) {
        return <div className="min-h-screen grid place-items-center"><p>Loading…</p></div>;
      }
      if (!user) return <LoginPage/>;

      const role = profile?.role || "employee";
      return (
        <div className="min-h-screen">
          <TopBar user={user} role={role} />
          <ManagerPanel role={role} />
          <CalendarStub user={user} role={role} />
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
